<sect1 id="ch05-locking-glibc">
<title>"Locking in" Glibc</title>
<?dbhtml filename="lockingglibc.html" dir="chapter05"?>

<para>Now that the temporary C libraries have been installed, we want all
the tools compiled in the rest of this chapter to be linked against these
libraries. To accomplish this, we need to adjust the linker's scripts and the
compiler's specs file.</para>

<para>First install the adjusted linker scripts by running the following from
within the <filename class="directory">binutils-build</filename>
directory:</para>

<para><screen><userinput>make -C ld install-data-local</userinput></screen></para>

<para>These scripts were adjusted a little while back, at the end of the first
pass of Binutils, and contain no mention of <filename>/lib</filename>,
<filename>/usr/lib</filename> or <filename>/usr/local/lib</filename>.
From this point onwards everything will link <emphasis>only</emphasis>
against the libraries in <filename>/stage1/lib</filename>.</para>

<para>You can now remove Binutils' build and source directories.</para>

<para>The other thing to do is to amend our GCC specs file so that it points
to the new dynamic linker. A simple sed will accomplish this:</para>
   
<para><screen><userinput>SPECFILE=/stage1/lib/gcc-lib/*/*/specs
sed -e 's@/lib/ld.so.1@/stage1/lib/ld.so.1@g' \
&nbsp;&nbsp;&nbsp;&nbsp;-e 's@/lib/ld-linux.so.2@/stage1/lib/ld-linux.so.2@g' \
&nbsp;&nbsp;&nbsp;&nbsp;$SPECFILE > tempspecfile
mv tempspecfile $SPECFILE
unset SPECFILE</userinput></screen></para>

<para>We recommend that you cut-and-paste the above rather than try and type
it all in. Or you can edit the specs file by hand if you want to: just replace
"/lib/ld-linux.so.2" with "/stage1/lib/ld-linux.so.2".</para>

<para>Also, because we allowed GCC's "Fixincludes" script to modify our host's
header files (and this was necessary because of improper use of the __thread
keyword in some older software), we want to get rid of those modified header
files, and replace them with pristine ones.</para>

<para><screen><userinput>GCCDIR=/stage1/lib/gcc-lib/*/*
rm -rf $GCCDIR/include/*
cp $GCCDIR/install-tools/include/* $GCCDIR/include
cp $GCCDIR/install-tools/gsyslimits.h \
   $GCCDIR/include/syslimits.h
unset GCCDIR</userinput></screen></para>

<para>This completes the installation of the self-contained toolchain, which
can now be used to build the rest of the temporary tools.</para>

</sect1>

